#ifndef TDH_HPP
#define TDH_HPP

#include <conio.h>
#include <windows.h>
#include <evntcons.h>
#include <evntrace.h>
#include <in6addr.h>
#include <stdio.h>
#include <strsafe.h>
#include <tdh.h>
#include <wbemidl.h>
#include <wmistr.h>
#include <string>
#include <map>

class TDH {

public:
  TDH(PEVENT_RECORD record);
  void print() const;

private:
  std::wstring m_guid;
  std::map<std::wstring, std::wstring> m_properties;
  unsigned int m_version;
  unsigned int m_opcode;
  unsigned int m_eventid;

  bool PropertyIsStructure(PEVENT_PROPERTY_INFO event_info);
  void WINAPI ProcessEvent(PEVENT_RECORD pEvent);
  DWORD GetEventInformation(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO &pInfo);
  PBYTE GatherProperties(const std::wstring &prefix, PEVENT_RECORD pEvent,
                         PTRACE_EVENT_INFO pInfo, DWORD PointerSize, USHORT i,
                         PBYTE pUserData, PBYTE pEndOfUserData);
  DWORD GetPropertyLength(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO pInfo,
                          USHORT i, PUSHORT PropertyLength);
  DWORD GetPropertyArraySize(PEVENT_RECORD pEvent, PTRACE_EVENT_INFO pInfo,
                             USHORT i, PUSHORT ArraySize);
  DWORD GetMapInfo(PEVENT_RECORD pEvent, LPWSTR pMapName, DWORD DecodingSource,
                   PEVENT_MAP_INFO &pMapInfo);
  void RemoveTrailingSpace(PEVENT_MAP_INFO pMapInfo);
};
#endif
